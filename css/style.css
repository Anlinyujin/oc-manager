/* ===== 重置 & 变量 ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --bg: #ffffff;
  --text: #1a1a1a;
  --text-secondary: #888888;
  --border: #e5e5e5;
  --hover: #f5f5f5;
  --danger: #ff3b30;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-user-select: none;
  user-select: none;
  overscroll-behavior: none;
}

input, textarea {
  -webkit-user-select: text;
  user-select: text;
}

.hidden { display: none !important; }

/* ===== Topbar ===== */
.topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 52px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 8px;
  padding-top: env(safe-area-inset-top);
  z-index: 100;
}

.topbar-title {
  font-size: 17px;
  font-weight: 600;
  margin-left: 4px;
  opacity: 0;
  transition: opacity 0.3s;
  flex: 1;
}

.topbar-title.visible { opacity: 1; }

.save-indicator {
  font-size: 12px;
  color: var(--text-secondary);
  opacity: 0;
  transition: opacity 0.3s;
  margin-right: 4px;
}

.save-indicator.visible { opacity: 1; }

.btn-icon {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s;
  flex-shrink: 0;
  font-size: 18px;
  color: var(--text);
}

.btn-icon:active { background: var(--hover); }

.btn-icon.note-corner {
  width: 32px;
  height: 32px;
  font-size: 16px;
}

.hamburger {
  display: flex;
  flex-direction: column;
  gap: 5px;
  width: 20px;
}

.hamburger span {
  display: block;
  height: 2px;
  background: var(--text);
  border-radius: 1px;
}

/* ===== Sidebar ===== */
.sidebar-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.sidebar-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.sidebar {
  position: fixed;
  top: 0; left: 0; bottom: 0;
  width: 240px;
  background: var(--bg);
  z-index: 201;
  transform: translateX(-100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
}

.sidebar.active { transform: translateX(0); }

.sidebar-header {
  padding: 20px 16px;
  padding-top: calc(20px + env(safe-area-inset-top));
  border-bottom: 1px solid var(--border);
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
}

.sidebar-header:active { opacity: 0.5; }

.sidebar-nav { flex: 1; padding: 8px; }

.sidebar-item {
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  transition: background 0.2s;
}

.sidebar-item:active { background: var(--hover); }

.sidebar-footer {
  padding: 8px;
  border-top: 1px solid var(--border);
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

.sidebar-footer-item {
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-secondary);
  transition: background 0.2s;
}

.sidebar-footer-item:active { background: var(--hover); }

/* ===== Main ===== */
.main {
  padding-top: calc(52px + env(safe-area-inset-top));
  min-height: 100vh;
  min-height: 100dvh;
}

.page {
  display: none;
  min-height: calc(100vh - 52px);
  min-height: calc(100dvh - 52px);
}

.page.active { display: block; }

.page-home {
  display: none;
  align-items: center;
  justify-content: center;
  min-height: calc(100vh - 52px);
  min-height: calc(100dvh - 52px);
}

.page-home.active { display: flex; }

.home-face {
  font-size: 32px;
  color: var(--border);
  margin-top: -15vh;
}

/* ===== Common page padding ===== */
.page-content {
  padding: 12px 16px 80px;
  padding-bottom: calc(80px + env(safe-area-inset-bottom));
}

/* ===== Action bar ===== */
.action-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.action-btn {
  flex: 1;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  font-size: 14px;
  color: var(--text);
  cursor: pointer;
  text-align: center;
  transition: background 0.2s;
}

.action-btn:active { background: var(--hover); }

/* ===== Class group ===== */
.class-group {
  margin-bottom: 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}

.class-header {
  display: flex;
  align-items: center;
  padding: 10px 4px 10px 12px;
}

.class-header-left {
  display: flex;
  align-items: center;
  flex: 1;
  cursor: pointer;
  padding: 4px 0;
}

.class-arrow {
  width: 18px;
  height: 18px;
  margin-right: 8px;
  transition: transform 0.3s;
  flex-shrink: 0;
}

.class-arrow.collapsed { transform: rotate(-90deg); }

.class-name {
  font-size: 15px;
  font-weight: 600;
  flex: 1;
}

.class-count {
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: 6px;
}

.class-actions, .char-actions {
  display: flex;
  align-items: center;
  flex-shrink: 0;
}

.small-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 6px;
  font-size: 14px;
  color: var(--text-secondary);
  transition: all 0.2s;
}

.small-btn:active {
  background: var(--hover);
  color: var(--text);
}

.small-btn svg { width: 16px; height: 16px; }

.class-body {
  overflow: hidden;
  transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}

.class-body.collapsed { max-height: 0 !important; }

.character-item, .note-item {
  display: flex;
  align-items: center;
  padding: 10px 4px 10px 16px;
  border-top: 1px solid var(--border);
  transition: background 0.2s;
}

.character-item-left, .note-item-left {
  display: flex;
  align-items: center;
  flex: 1;
  cursor: pointer;
  padding: 4px 0;
  min-width: 0;
}

.char-name {
  font-size: 15px;
  flex: 1;
  padding-left: 26px;
}

.character-item:active .character-item-left { opacity: 0.6; }

.add-character-btn, .add-note-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 14px;
  transition: background 0.2s;
}

.add-character-btn:active, .add-note-btn:active { background: var(--hover); }

.add-class-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 16px;
  margin-top: 12px;
  border: 1px dashed var(--border);
  border-radius: 10px;
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 14px;
  transition: background 0.2s;
}

.add-class-btn:active { background: var(--hover); }

/* ===== Export select ===== */
.select-circle {
  width: 24px;
  height: 24px;
  border: 2px solid var(--border);
  border-radius: 50%;
  margin-right: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  flex-shrink: 0;
  transition: all 0.2s;
}

.select-circle.selected {
  border-color: var(--text);
  background: var(--text);
  color: var(--bg);
}

.export-bottom-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  padding: 12px 16px;
  padding-bottom: calc(12px + env(safe-area-inset-bottom));
  background: var(--bg);
  border-top: 1px solid var(--border);
  z-index: 50;
  transform: translateY(100%);
  transition: transform 0.3s;
}

.export-bottom-bar.visible { transform: translateY(0); }

.export-confirm-btn {
  width: 100%;
  padding: 13px;
  border: none;
  border-radius: 8px;
  background: var(--text);
  color: var(--bg);
  font-size: 15px;
  cursor: pointer;
}

.export-confirm-btn:active { opacity: 0.7; }

/* ===== Edit page ===== */
.edit-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.back-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  border: none;
  background: none;
  font-size: 15px;
  color: var(--text);
  cursor: pointer;
  padding: 6px 0;
}

.back-btn:active { opacity: 0.5; }

.delete-btn {
  border: none;
  background: none;
  font-size: 14px;
  color: var(--danger);
  cursor: pointer;
  padding: 6px 12px;
}

.section { margin-bottom: 24px; }

.section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  letter-spacing: 1px;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.field-row { margin-bottom: 12px; }

.field-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.field-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 15px;
  color: var(--text);
  background: var(--bg);
  outline: none;
  transition: border-color 0.2s;
  font-family: inherit;
}

.field-input:focus { border-color: #999; }

textarea.field-input {
  resize: vertical;
  min-height: 80px;
  line-height: 1.6;
}

textarea.field-input.large { min-height: 120px; }

.list-item {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  align-items: flex-start;
}

.list-item-number {
  font-size: 14px;
  color: var(--text-secondary);
  padding-top: 10px;
  flex-shrink: 0;
  min-width: 24px;
  text-align: right;
}

.list-item-content { flex: 1; }

.list-item-delete {
  border: none;
  background: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 10px 4px;
  font-size: 16px;
  flex-shrink: 0;
}

.list-item-delete:active { color: var(--danger); }

.add-item-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 0;
  border: none;
  background: none;
  color: var(--text-secondary);
  font-size: 14px;
  cursor: pointer;
}

.add-item-btn:active { color: var(--text); }

.relation-card {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.relation-card-top {
  display: flex;
  gap: 8px;
  align-items: flex-start;
}

.relation-card-fields { flex: 1; }

.relation-card-delete {
  border: none;
  background: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 6px;
  font-size: 18px;
  flex-shrink: 0;
}

.relation-card-delete:active { color: var(--danger); }

/* ===== Preview page ===== */
.preview-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.preview-actions { display: flex; gap: 8px; }

.preview-btn {
  padding: 8px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  font-size: 14px;
  color: var(--text);
  cursor: pointer;
}

.preview-btn:active { background: var(--hover); }

.preview-textarea {
  width: 100%;
  min-height: calc(100vh - 140px);
  min-height: calc(100dvh - 140px);
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  font-family: "SF Mono", "Menlo", "Consolas", monospace;
  line-height: 1.6;
  color: var(--text);
  background: var(--bg);
  outline: none;
  resize: vertical;
  -webkit-user-select: text;
  user-select: text;
}

/* ===== Compact toggle ===== */
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  margin-bottom: 12px;
}

.toggle-label { font-size: 14px; color: var(--text); }

.toggle-switch {
  width: 44px;
  height: 24px;
  border-radius: 12px;
  background: var(--border);
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
  flex-shrink: 0;
}

.toggle-switch.active { background: var(--text); }

.toggle-switch::after {
  content: '';
  position: absolute;
  top: 2px; left: 2px;
  width: 20px; height: 20px;
  border-radius: 50%;
  background: var(--bg);
  transition: transform 0.3s;
}

.toggle-switch.active::after { transform: translateX(20px); }

/* ===== Notes list ===== */
.note-item-info { flex: 1; min-width: 0; }

.note-item-title {
  font-size: 15px;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.note-item-tags {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ===== Note edit ===== */
.note-edit-page {
  min-height: 100vh;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
}

.note-edit-topnav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 12px 8px;
  padding-top: calc(12px + env(safe-area-inset-top));
  flex-shrink: 0;
}

.note-edit-topnav .btn-icon {
  width: 32px; height: 32px; font-size: 16px;
}

.note-edit-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0 16px;
  padding-bottom: calc(60px + env(safe-area-inset-bottom));
}

.char-edit-body {
  padding-bottom: calc(80px + env(safe-area-inset-bottom));
}

.note-title-clean {
  width: 100%;
  border: none;
  outline: none;
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  background: transparent;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-family: inherit;
  -webkit-user-select: text;
  user-select: text;
}

.note-tags-clean {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  min-height: 36px;
}

.note-tag-sm {
  font-size: 12px;
  color: var(--text-secondary);
  padding: 2px 8px;
  border: 1px solid var(--border);
  border-radius: 10px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.note-tag-sm-remove {
  cursor: pointer;
  font-size: 10px;
  color: var(--text-secondary);
}

.note-tag-sm-remove:active { color: var(--danger); }

.note-tag-sm-add {
  font-size: 12px;
  color: var(--text-secondary);
  padding: 2px 8px;
  border: 1px dashed var(--border);
  border-radius: 10px;
  cursor: pointer;
}

.note-tag-sm-add:active { background: var(--hover); }

.note-content-clean {
  flex: 1;
  width: 100%;
  border: none;
  outline: none;
  font-size: 14px;
  line-height: 1.8;
  color: var(--text);
  background: transparent;
  padding: 12px 0;
  resize: none;
  font-family: inherit;
  -webkit-user-select: text;
  user-select: text;
  min-height: 50vh;
}

/* ===== Note preview ===== */
.note-preview-clean {
  flex: 1;
  padding: 12px 0;
  font-size: 14px;
  line-height: 1.8;
  color: var(--text);
}

.note-preview-clean h1 { font-size: 20px; margin: 14px 0 6px; font-weight: 700; }
.note-preview-clean h2 { font-size: 17px; margin: 12px 0 5px; font-weight: 700; }
.note-preview-clean h3 { font-size: 15px; margin: 10px 0 4px; font-weight: 700; }
.note-preview-clean h4 { font-size: 14px; margin: 8px 0 3px; font-weight: 700; }
.note-preview-clean p { margin: 6px 0; }
.note-preview-clean ul, .note-preview-clean ol { padding-left: 20px; margin: 6px 0; }
.note-preview-clean li { margin: 3px 0; }
.note-preview-clean li ul, .note-preview-clean li ol { margin: 2px 0; }
.note-preview-clean strong { font-weight: 700; }
.note-preview-clean em { font-style: italic; }
.note-preview-clean u { text-decoration: underline; }
.note-preview-clean del { text-decoration: line-through; color: var(--text-secondary); }
.note-preview-clean code {
  background: var(--hover);
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 13px;
  font-family: "SF Mono", "Menlo", monospace;
}
.note-preview-clean pre {
  background: var(--hover);
  padding: 10px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 6px 0;
  position: relative;
}
.note-preview-clean pre code { background: none; padding: 0; }
.note-preview-clean blockquote {
  border-left: 3px solid var(--border);
  padding: 4px 0 4px 12px;
  color: var(--text-secondary);
  margin: 6px 0;
}
.note-preview-clean blockquote blockquote { margin: 4px 0; }
.note-preview-clean hr {
  border: none;
  border-top: 1px solid var(--border);
  margin: 14px 0;
}
.note-preview-clean table {
  border-collapse: collapse;
  width: 100%;
  margin: 6px 0;
  font-size: 13px;
}
.note-preview-clean th, .note-preview-clean td {
  border: 1px solid var(--border);
  padding: 6px 10px;
  text-align: left;
}
.note-preview-clean th { background: var(--hover); font-weight: 600; }
.note-preview-clean details {
  margin: 6px 0;
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
}
.note-preview-clean summary {
  padding: 8px 12px;
  cursor: pointer;
  font-weight: 600;
  background: var(--hover);
}
.note-preview-clean details > div { padding: 8px 12px; }
.note-preview-clean mark {
  background: #fff3b0;
  padding: 1px 3px;
  border-radius: 2px;
}

.code-copy-btn {
  position: absolute;
  top: 6px; right: 6px;
  padding: 3px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg);
  font-size: 11px;
  color: var(--text-secondary);
  cursor: pointer;
}
.code-copy-btn:active { background: var(--hover); }

/* ===== MD Toolbar ===== */
.md-toolbar {
  position: fixed;
  left: 0; right: 0;
  bottom: 0;
  background: var(--bg);
  border-top: 1px solid var(--border);
  z-index: 90;
  display: none;
  flex-direction: column;
  padding-bottom: env(safe-area-inset-bottom);
}

.md-toolbar.visible { display: flex; }

.md-toolbar-scroll {
  display: flex;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding: 6px 8px;
  gap: 2px;
}

.md-toolbar-scroll::-webkit-scrollbar { display: none; }

.md-tool-btn {
  flex-shrink: 0;
  min-width: 38px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  padding: 0 8px;
  transition: background 0.15s;
  font-family: inherit;
}

.md-tool-btn:active { background: var(--hover); }

.md-tool-sep {
  flex-shrink: 0;
  width: 1px;
  height: 20px;
  background: var(--border);
  margin: 7px 4px;
}

/* ===== MD Toolbar popup ===== */
.md-popup {
  position: fixed;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
  z-index: 95;
  padding: 8px;
  display: none;
  max-width: 280px;
}

.md-popup.visible { display: block; }

.md-popup-item {
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  white-space: nowrap;
  transition: background 0.15s;
}

.md-popup-item:active { background: var(--hover); }

.md-popup-colors {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  padding: 4px;
}

.md-color-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid var(--border);
  cursor: pointer;
  transition: transform 0.15s;
}

.md-color-btn:active { transform: scale(0.9); }

.md-popup-table { padding: 8px; }

.md-popup-table-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.md-popup-table-row {
  display: flex;
  gap: 6px;
  margin-bottom: 8px;
}

.md-popup-table-num {
  width: 36px;
  height: 32px;
  border: 1px solid var(--border);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.15s;
}

.md-popup-table-num.selected {
  background: var(--text);
  color: var(--bg);
  border-color: var(--text);
}

.md-popup-table-num:active { opacity: 0.6; }

.md-popup-insert {
  width: 100%;
  padding: 8px;
  border: none;
  border-radius: 6px;
  background: var(--text);
  color: var(--bg);
  font-size: 14px;
  cursor: pointer;
  margin-top: 4px;
}

.md-popup-insert:active { opacity: 0.7; }

/* ===== Tag manager ===== */
.tag-section { margin-bottom: 24px; }

.tag-section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}

.tag-list { display: flex; flex-wrap: wrap; gap: 8px; }

.tag-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 16px;
  font-size: 14px;
}

.tag-chip-auto { color: var(--text-secondary); font-style: italic; }

.tag-chip-delete {
  cursor: pointer;
  font-size: 13px;
  color: var(--text-secondary);
}

.tag-chip-delete:active { color: var(--danger); }

.tag-add-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border: 1px dashed var(--border);
  border-radius: 16px;
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
}

.tag-add-btn:active { background: var(--hover); }

/* ===== Filter modal ===== */
.filter-modal-content {
  max-height: 60vh;
  overflow-y: auto;
  text-align: left;
  padding: 0 4px;
}

.filter-section { margin-bottom: 16px; }

.filter-section-header {
  display: flex;
  align-items: center;
  padding: 8px 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
}

.filter-section-header:active { opacity: 0.6; }

.filter-section-arrow {
  width: 14px; height: 14px;
  margin-right: 6px;
  transition: transform 0.3s;
}

.filter-section-arrow.collapsed { transform: rotate(-90deg); }

.filter-items {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 4px 0;
  overflow: hidden;
  transition: max-height 0.3s;
}

.filter-items.collapsed { max-height: 0 !important; padding: 0; }

.filter-chip {
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 16px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-chip:active { opacity: 0.6; }

.filter-chip.selected {
  background: var(--text);
  color: var(--bg);
  border-color: var(--text);
}

/* ===== Note export ===== */
.note-export-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.note-export-actions .preview-btn { flex: 1; min-width: 0; }

/* ===== Modal ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s;
}

.modal-overlay.active { opacity: 1; pointer-events: auto; }

.modal {
  background: var(--bg);
  border-radius: 14px;
  width: 100%;
  max-width: 320px;
  overflow: hidden;
  transform: scale(0.95);
  transition: transform 0.25s;
}

.modal-overlay.active .modal { transform: scale(1); }

.modal-body { padding: 20px 16px 16px; }

.modal-body p {
  font-size: 15px;
  line-height: 1.5;
  text-align: center;
  margin-bottom: 4px;
}

.modal-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 15px;
  margin-top: 12px;
  outline: none;
  text-align: center;
  -webkit-user-select: text;
  user-select: text;
}

.modal-input:focus { border-color: #999; }

.modal-actions {
  display: flex;
  border-top: 1px solid var(--border);
}

.modal-btn {
  flex: 1;
  padding: 14px;
  border: none;
  background: none;
  font-size: 16px;
  cursor: pointer;
  transition: background 0.2s;
}

.modal-btn:active { background: var(--hover); }
.modal-btn + .modal-btn { border-left: 1px solid var(--border); }
.modal-btn.danger { color: var(--danger); }
.modal-btn.primary { font-weight: 600; }

/* ===== Toast ===== */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--text);
  color: var(--bg);
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 14px;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s;
  z-index: 400;
  white-space: nowrap;
}

.toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ===== Tag select modal ===== */
.tag-select-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  margin-bottom: 12px;
}

.tag-select-tab {
  flex: 1;
  padding: 10px;
  text-align: center;
  font-size: 14px;
  cursor: pointer;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tag-select-tab.active {
  color: var(--text);
  border-bottom-color: var(--text);
}

.tag-select-body {
  max-height: 50vh;
  overflow-y: auto;
  text-align: left;
}

.tag-select-group { margin-bottom: 12px; }

.tag-select-group-header {
  display: flex;
  align-items: center;
  padding: 6px 0;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
}

.tag-select-group-arrow {
  width: 12px; height: 12px;
  margin-right: 4px;
  transition: transform 0.3s;
}

.tag-select-group-arrow.collapsed { transform: rotate(-90deg); }

.tag-select-items {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 4px 0 4px 16px;
}

.tag-select-chip {
  padding: 5px 12px;
  border: 1px solid var(--border);
  border-radius: 14px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.tag-select-chip:active { opacity: 0.6; }

.tag-select-chip.selected {
  background: var(--text);
  color: var(--bg);
  border-color: var(--text);
}

/* ===== 歌词占位弹窗 ===== */
.lyrics-adjust-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 600;
  background: var(--bg);
  padding: 16px 20px;
  padding-bottom: calc(16px + env(safe-area-inset-bottom));
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  border-radius: 16px 16px 0 0;
  border-top: 1px solid var(--border);
}

.lyrics-slider-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.lyrics-slider-label {
  font-size: 13px;
  color: var(--text-secondary);
  min-width: 28px;
  flex-shrink: 0;
}

.lyrics-slider {
  flex: 1;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--border);
  border-radius: 2px;
  outline: none;
}

.lyrics-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--text-secondary);
  cursor: pointer;
}

.lyrics-slider-value {
  font-size: 13px;
  color: var(--text-secondary);
  min-width: 28px;
  text-align: right;
  flex-shrink: 0;
}

.lyrics-colors {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin: 14px 0;
  flex-wrap: wrap;
}

.lyrics-color-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.15s;
  flex-shrink: 0;
}

.lyrics-color-btn:active { transform: scale(0.9); }

.lyrics-color-btn.lyrics-color-selected {
  outline: 2px solid var(--text);
  outline-offset: 2px;
}

.lyrics-actions {
  display: flex;
  gap: 10px;
  margin-top: 4px;
}

.lyrics-action-btn {
  flex: 1;
  padding: 11px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  font-size: 14px;
  color: var(--text);
  cursor: pointer;
  text-align: center;
  transition: background 0.2s;
}

.lyrics-action-btn:active { background: var(--hover); }

.lyrics-close-btn { color: var(--text-secondary); }

/* ===== 设置页 ===== */
.settings-list { padding: 20px; }

.settings-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 0;
  border-bottom: 1px solid var(--border);
}

.settings-label {
  font-size: 16px;
  color: var(--text);
}

.settings-toggle {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
}

.settings-toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ddd;
  border-radius: 26px;
  transition: background-color 0.3s;
}

.toggle-slider:before {
  content: "";
  position: absolute;
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  border-radius: 50%;
  transition: transform 0.3s;
}

.settings-toggle input:checked + .toggle-slider {
  background-color: #555;
}

.settings-toggle input:checked + .toggle-slider:before {
  transform: translateX(22px);
}

/* ========================================
   PC端适配（768px以上）
   ======================================== */
@media (min-width: 768px) {
  /* 整体字号 */
  html { font-size: 17px; }

  /* --- 侧边栏常驻 --- */
  .sidebar {
    transform: translateX(0) !important;
    width: 240px;
    box-shadow: none;
  }

  .sidebar-overlay { display: none !important; }
  .hamburger { display: none !important; }

  .sidebar-header { font-size: 20px; padding: 20px 24px; }
  .sidebar-item, .sidebar-footer-item { font-size: 16px; padding: 14px 24px; }

  /* --- 主内容区让位 --- */
  #mainContent { margin-left: 240px; }

  .topbar {
    left: 240px;
    width: calc(100% - 240px);
    height: 56px;
  }

  .topbar-title { font-size: 18px; }

  /* --- 内容限宽居中 --- */
  .page-content {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px 40px;
  }

  /* --- 编辑页导航栏 --- */
  .note-edit-topnav {
    left: 240px;
    width: calc(100% - 240px);
    height: 56px;
  }

  .note-edit-topnav button { font-size: 20px; padding: 12px 20px; }

  /* --- 编辑页内容区 --- */
  .note-edit-page {
    width: 100% !important;
    align-items: stretch !important;
  }

  .char-edit-body,
  .note-edit-body {
    width: 100% !important;
    max-width: none !important;
    margin: 0 !important;
    padding: 20px 60px !important;
    box-sizing: border-box !important;
    align-items: stretch !important;
  }

  .section,
  .field-row,
  .note-tags-clean {
    width: 100% !important;
    max-width: none !important;
  }

  /* --- 输入框撑满 --- */
  .char-edit-body input,
  .char-edit-body textarea,
  .char-edit-body select,
  .note-edit-body input,
  .note-edit-body textarea,
  .note-title-clean,
  .note-content-clean {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    font-size: 16px;
  }

  /* --- 字号调整 --- */
  .section-title { font-size: 16px; width: 100%; }
  .field-label { font-size: 15px; }
  .note-title-clean { font-size: 22px; }
  .note-content-clean { font-size: 16px; line-height: 1.8; }
  .note-preview-clean { font-size: 16px; line-height: 1.8; width: 100%; }
  .tag-section-title { font-size: 16px; }
  .action-btn { font-size: 16px; padding: 12px 0; }
  .note-item-title { font-size: 16px; }
  .settings-label { font-size: 16px; }

  /* --- MD工具栏让位 --- */
  .md-toolbar {
    left: 240px;
    width: calc(100% - 240px);
    padding: 8px 12px;
  }

  .md-toolbar button { font-size: 16px; min-width: 36px; height: 36px; }

  .md-popup {
    left: calc(240px + 50%) !important;
    transform: translateX(-50%) !important;
    font-size: 15px;
  }

  /* --- 导出底部栏让位 --- */
  .export-bottom-bar {
    left: 240px;
    width: calc(100% - 240px);
  }

  .export-confirm-btn { font-size: 16px; }

  /* --- 弹窗居中让位 --- */
  .modal-overlay { padding-left: 240px; }
  .modal { max-width: 460px; }
  .modal-body { font-size: 16px; padding: 24px; }
  .modal-actions button { font-size: 16px; padding: 14px; }

  /* --- 歌词让位 --- */
  .lyrics-block {
    margin-left: 240px;
    width: calc(100% - 240px) !important;
  }

  .lyrics-adjust-panel {
    left: 240px;
    width: calc(100% - 240px);
  }

  /* --- Toast让位 --- */
  .toast {
    left: calc(240px + (100% - 240px) / 2);
    transform: translateX(-50%);
    font-size: 15px;
  }

  /* --- 首页 --- */
  .home-face { font-size: 48px; }

  /* --- 人设卡编辑页 Grid 美化 --- */
  .char-edit-body .section {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px 30px;
  }

  .char-edit-body .section-title {
    grid-column: 1 / -1;
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 18px;
    font-weight: 600;
    border-bottom: 2px solid #f5f5f5;
    padding-bottom: 12px;
  }

  .char-edit-body .field-row:has(textarea) {
    grid-column: 1 / -1;
  }

  .char-edit-body .field-label {
    font-weight: 500;
    color: #666;
    margin-bottom: 8px;
  }

  .char-edit-body input[type="text"],
  .char-edit-body input:not([type]),
  .char-edit-body textarea,
  .char-edit-body select {
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    transition: all 0.2s;
  }

  .char-edit-body input[type="text"]:focus,
  .char-edit-body input:not([type]):focus,
  .char-edit-body textarea:focus,
  .char-edit-body select:focus {
    background: #fff;
    border-color: #888;
    box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
  }

  .note-edit-topnav {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
  }
}

/* ===== 更大屏幕（1200px+） ===== */
@media (min-width: 1200px) {
  .page-content { max-width: 1200px; }
  .settings-page { max-width: 800px; }
  .modal { max-width: 600px; }
  .note-title-clean { font-size: 28px; }
}

/* ========================================
   夜间模式
   ======================================== */
body.dark-mode {
  background-color: #1a1a1a;
  color: #e0e0e0;
}

/* --- Topbar --- */
body.dark-mode .topbar {
  background: #1a1a1a;
  border-bottom-color: #333;
}

body.dark-mode .topbar-title { color: #e0e0e0; }
body.dark-mode .hamburger span { background: #e0e0e0; }
body.dark-mode .save-indicator { color: #888; }

/* --- Sidebar --- */
body.dark-mode .sidebar {
  background: #222;
  border-right-color: #333;
}

body.dark-mode .sidebar-header {
  color: #e0e0e0;
  border-bottom-color: #333;
}

body.dark-mode .sidebar-item,
body.dark-mode .sidebar-footer-item { color: #ccc; }

body.dark-mode .sidebar-item:active,
body.dark-mode .sidebar-footer-item:active { background: #333; }

body.dark-mode .sidebar-footer { border-top-color: #333; }

/* --- Pages --- */
body.dark-mode .page { background: #1a1a1a; }
body.dark-mode .home-face { color: #555; }

/* --- 输入框统一 --- */
body.dark-mode input[type="text"],
body.dark-mode input:not([type]),
body.dark-mode input[type="number"],
body.dark-mode input[type="search"],
body.dark-mode textarea,
body.dark-mode select {
  background: #2a2a2a;
  color: #e0e0e0;
  border-color: #444;
}

/* --- 人设卡列表 --- */
body.dark-mode .class-group { border-color: #444; }
body.dark-mode .character-item { border-top-color: #333; }
body.dark-mode .add-character-btn { border-top-color: #333; color: #888; }
body.dark-mode .add-class-btn { border-color: #444; color: #888; }

body.dark-mode .action-btn {
  background: #2a2a2a;
  color: #e0e0e0;
  border-color: #444;
}

body.dark-mode .action-btn:active { background: #333; }

/* --- 编辑页 --- */
body.dark-mode .section-title {
  color: #aaa;
  border-bottom-color: #333;
}

body.dark-mode .field-label { color: #999; }

body.dark-mode .relation-card { border-color: #444; }

body.dark-mode .toggle-label { color: #ccc; }
body.dark-mode .toggle-switch { background: #444; }
body.dark-mode .toggle-switch.active { background: #888; }

/* --- 笔记列表 --- */
body.dark-mode .note-item { border-top-color: #333; }
body.dark-mode .note-item-title { color: #e0e0e0; }

/* --- 笔记编辑 --- */
body.dark-mode .note-edit-topnav {
  background: #1a1a1a;
  border-bottom-color: #333;
}

body.dark-mode .note-edit-topnav button { color: #e0e0e0; }

body.dark-mode .note-title-clean {
  color: #e0e0e0;
  background: transparent !important;
  border-color: transparent !important;
  border-bottom-color: #333 !important;
}

body.dark-mode .note-tags-clean { border-bottom-color: #333; }

body.dark-mode .note-tag-sm { border-color: #444; color: #aaa; }
body.dark-mode .note-tag-sm-add { border-color: #444; color: #888; }

body.dark-mode .note-content-clean { background: transparent; }

/* --- 笔记预览 --- */
body.dark-mode .note-preview-clean { color: #e0e0e0; }

body.dark-mode .note-preview-clean blockquote {
  border-left-color: #555;
  color: #aaa;
  background: #222;
}

body.dark-mode .note-preview-clean pre {
  background: #2a2a2a;
  border-color: #444;
}

body.dark-mode .note-preview-clean code {
  background: #333;
  color: #e0e0e0;
}

body.dark-mode .note-preview-clean table { border-color: #444; }

body.dark-mode .note-preview-clean th {
  background: #333;
  border-color: #444;
  color: #e0e0e0;
}

body.dark-mode .note-preview-clean td { border-color: #444; }
body.dark-mode .note-preview-clean hr { border-color: #444; }

body.dark-mode .note-preview-clean .collapsible-block {
  background: #222;
  border-color: #444;
}

/* --- MD工具栏 --- */
body.dark-mode .md-toolbar {
  background: #222;
  border-top-color: #444;
}

body.dark-mode .md-toolbar button { color: #ccc; }

body.dark-mode .md-popup {
  background: #2a2a2a;
  border-color: #444;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.5);
}

body.dark-mode .md-popup div:active,
body.dark-mode .md-popup button:active { background: #444; }

/* --- 弹窗 --- */
body.dark-mode .modal { background: #2a2a2a; }
body.dark-mode .modal-body { color: #e0e0e0; }
body.dark-mode .modal-actions { border-top-color: #444; }
body.dark-mode .modal-actions button { color: #e0e0e0; }
body.dark-mode .modal-btn + .modal-btn { border-left-color: #444; }
body.dark-mode .modal-input { background: #333; color: #e0e0e0; border-color: #555; }

/* --- Toast --- */
body.dark-mode .toast { background: #444; color: #e0e0e0; }

/* --- 导出 --- */
body.dark-mode .export-bottom-bar { background: #222; border-top-color: #444; }
body.dark-mode .export-confirm-btn { background: #e0e0e0; color: #1a1a1a; }
body.dark-mode .select-circle { border-color: #555; }
body.dark-mode .select-circle.selected { border-color: #e0e0e0; background: #e0e0e0; color: #1a1a1a; }

body.dark-mode .preview-textarea { background: #2a2a2a; color: #e0e0e0; border-color: #444; }
body.dark-mode .preview-btn { background: #2a2a2a; color: #e0e0e0; border-color: #444; }
body.dark-mode .preview-btn:active { background: #333; }

body.dark-mode .export-preview-box { background: #2a2a2a; border-color: #444; color: #e0e0e0; }
body.dark-mode .export-preview-box textarea { background: #2a2a2a; color: #e0e0e0; border-color: #444; }
body.dark-mode .export-option-btn { background: #333; color: #e0e0e0; border-color: #444; }
body.dark-mode .export-option-btn:active { background: #444; }

/* --- 标签管理 --- */
body.dark-mode .tag-section-title { color: #aaa; border-bottom-color: #333; }
body.dark-mode .tag-chip { border-color: #444; color: #e0e0e0; }
body.dark-mode .tag-chip-auto { color: #888; }
body.dark-mode .tag-add-btn { border-color: #444; color: #888; }

/* --- 筛选/标签选择 --- */
body.dark-mode .filter-chip { border-color: #444; color: #ccc; }
body.dark-mode .filter-chip.selected { background: #e0e0e0; color: #1a1a1a; border-color: #e0e0e0; }
body.dark-mode .tag-select-chip { border-color: #444; color: #ccc; }
body.dark-mode .tag-select-chip.selected { background: #e0e0e0; color: #1a1a1a; border-color: #e0e0e0; }

/* --- 设置页 --- */
body.dark-mode .settings-item { border-bottom-color: #333; }
body.dark-mode .settings-label { color: #e0e0e0; }
body.dark-mode .toggle-slider { background-color: #555; }
body.dark-mode .settings-toggle input:checked + .toggle-slider { background-color: #888; }

/* --- 歌词面板 --- */
body.dark-mode .lyrics-adjust-panel {
  background: #2a2a2a;
  border-top-color: #444;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
}

body.dark-mode .lyrics-slider::-webkit-slider-thumb { background: #bbb; }
body.dark-mode .lyrics-color-btn.lyrics-color-selected { outline-color: #ccc; }
body.dark-mode .lyrics-action-btn { background: #333; color: #e0e0e0; border-color: #444; }
body.dark-mode .lyrics-action-btn:active { background: #444; }
body.dark-mode .lyrics-close-btn { color: #888; }

/* --- 操作菜单 --- */
body.dark-mode .char-actions-menu { background: #2a2a2a; border-color: #444; }
body.dark-mode .char-actions-menu div { color: #e0e0e0; }
body.dark-mode .char-actions-menu div:active { background: #444; }

/* --- 夜间模式 + PC端 --- */
@media (min-width: 768px) {
  body.dark-mode .char-edit-body .section {
    background: #222;
    border-color: #333;
  }

  body.dark-mode .char-edit-body .section-title {
    border-bottom-color: #333;
  }

  body.dark-mode .char-edit-body input[type="text"],
  body.dark-mode .char-edit-body input:not([type]),
  body.dark-mode .char-edit-body textarea,
  body.dark-mode .char-edit-body select {
    background: #2a2a2a;
    border-color: #444;
  }

  body.dark-mode .char-edit-body input[type="text"]:focus,
  body.dark-mode .char-edit-body input:not([type]):focus,
  body.dark-mode .char-edit-body textarea:focus,
  body.dark-mode .char-edit-body select:focus {
    background: #333;
    border-color: #666;
  }

  body.dark-mode .note-edit-topnav {
    background: rgba(26,26,26,0.9);
  }
}

/* 导入弹窗textarea */
.modal-textarea {
  width: 100%;
  box-sizing: border-box;
  resize: vertical;
  font-size: 14px;
  font-family: monospace;
  margin-top: 8px;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fff;
  color: #333;
}

/* 移动班级选项 */
.move-class-item:active {
  background: #f0f0f0;
}

/* 夜间模式 */
body.dark-mode .modal-textarea {
  background: #2a2a2a;
  color: #e0e0e0;
  border-color: #444;
}

body.dark-mode .move-class-item {
  border-color: #444;
  color: #e0e0e0;
}

body.dark-mode .move-class-item:active {
  background: #333;
}

/* 条目操作按钮（替代原×） */
.list-item-more,
.relation-card-more {
  background: none;
  border: none;
  font-size: 18px;
  color: #999;
  cursor: pointer;
  padding: 4px 8px;
  flex-shrink: 0;
}

.list-item-more:active,
.relation-card-more:active {
  color: #666;
}

body.dark-mode .list-item-more,
body.dark-mode .relation-card-more {
  color: #777;
}

body.dark-mode .list-item-more:active,
body.dark-mode .relation-card-more:active {
  color: #aaa;
}
